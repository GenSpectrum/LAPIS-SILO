FROM alpine:3.20

ARG TARGETPLATFORM

RUN apk update && apk add --no-cache py3-pip \
    build-base=0.5-r3 \
    cmake=3.29.3-r0 \
    bash=5.2.26-r0 \
    linux-headers=6.6-r0 \
    boost-build=1.84.0-r0 \
    onetbb=2021.12.0-r0

RUN pip install conan==2.4.1 --break-system-packages

WORKDIR /src
COPY conanfile.py conanprofile.docker conanprofile.docker_arm ./
RUN if [ "$TARGETPLATFORM" = "linux/arm64" ]; then \
        mv conanprofile.docker_arm conanprofile; \
    else \
        mv conanprofile.docker conanprofile; \
    fi

RUN conan install . --build=missing --profile ./conanprofile --profile:build ./conanprofile --output-folder=build

all: bench

# Required env vars, besides those already checked in `Makefile`:

# Our custom parameters:

# Should API query order be randomized?
ifeq ($(RANDOMIZED),0)
API_QUERY_OPTS=
else ifeq ($(RANDOMIZED),1)
API_QUERY_OPTS=--randomize
else
$(error "RANDOMIZED must be either 0 or 1, got '$(RANDOMIZED)'")
endif
export API_QUERY_OPTS

# Passed to api-query
ifeq ($(CONCURRENCY),)
$(error "CONCURRENCY must be a natural number, missing")
endif

# Passed to api-query
ifeq ($(REPEAT),)
$(error "REPEAT must be a natural number, missing")
endif


ifeq ($(QUERIES),)
QUERIES=queries
endif
export QUERIES

QUERIES_DIR=$(DATASET_DIR)/$(QUERIES)
export QUERIES_DIR

# ---- Get dependencies --------------------------------------------------------

API_QUERY_VERSION=eb682c8c602578f6b6d4548f5c2b11b14de5b7ed

API_QUERY_DIR=api-query
API_QUERY_CLONE=$(API_QUERY_DIR)/Cargo.toml
API_QUERY_CHECKOUT_STAMP_DIR=$(API_QUERY_DIR)/.git/.checkout
API_QUERY_CHECKOUT=$(API_QUERY_CHECKOUT_STAMP_DIR)/$(API_QUERY_VERSION)
API_QUERY=$(API_QUERY_DIR)/target/release/api-query
export API_QUERY

API_QUERY_LOG_CSV:=$(OUTPUT_DIR)/api-query-log-$(shell bin/date-rfc-3339).csv
export API_QUERY_LOG_CSV

$(API_QUERY_CLONE):
	git clone https://github.com/GenSpectrum/api-query $(API_QUERY_DIR)

$(API_QUERY_CHECKOUT): $(API_QUERY_CLONE)
	rm -rf $(API_QUERY_CHECKOUT_STAMP_DIR) # remove previous version stamp
	( cd $(API_QUERY_DIR) && git remote update && git checkout -b local_hidden_$(API_QUERY_VERSION) $(API_QUERY_VERSION) )
	mkdir -p $(API_QUERY_CHECKOUT_STAMP_DIR)
	touch $(API_QUERY_CHECKOUT)

$(API_QUERY): $(API_QUERY_CHECKOUT)
	cd $(API_QUERY_DIR) && cargo build --release


# just for manual call comfort
dependencies: $(API_QUERY)

# ---- Running silo -----------------------------------------------------------

.silo.pid: $(PREPROCESSING_STAMP)
	rm -f .silo.stopped
	bin/start-silo

.silo.stopped:
	bin/stop-silo
	touch .silo.stopped

bench: $(QUERIES_DIR)/queries.ndjson $(API_QUERY) .silo.stopped
	@echo "running benchmark"
	make -f Makefile_api .silo.pid
	bin/api-query-iter
	make -f Makefile_api .silo.stopped
	bin/api-query-log-compare
